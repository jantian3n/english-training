# ============================================
# Production Docker Compose with Nginx
# ============================================

version: '3.8'

services:
  # Main Application
  web:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: english-training-web
    restart: unless-stopped

    # Only expose to localhost if using Nginx
    ports:
      - "127.0.0.1:3000:3000"

    environment:
      DATABASE_URL: "file:/app/prisma/data/dev.db"
      NEXTAUTH_URL: "${NEXTAUTH_URL}"
      NEXTAUTH_SECRET: "${NEXTAUTH_SECRET}"
      DEEPSEEK_API_KEY: "${DEEPSEEK_API_KEY}"
      ADMIN_EMAIL: "${ADMIN_EMAIL}"
      ADMIN_PASSWORD: "${ADMIN_PASSWORD}"
      NODE_ENV: production

    volumes:
      - ./data:/app/prisma/data
      - ./logs:/app/logs

    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    networks:
      - app-network

  # Nginx Reverse Proxy (Optional)
  nginx:
    image: nginx:alpine
    container_name: english-training-nginx
    restart: unless-stopped

    ports:
      - "80:80"
      - "443:443"

    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - ./logs/nginx:/var/log/nginx

    depends_on:
      - web

    networks:
      - app-network

networks:
  app-network:
    driver: bridge

# ============================================
# Usage:
#
# With Nginx:
#   docker-compose -f docker-compose.prod.yml up -d
#
# Without Nginx (direct access):
#   Use the regular docker-compose.yml
# ============================================
